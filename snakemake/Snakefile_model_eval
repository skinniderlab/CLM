configfile: "config.json"
threads: 1
# -----------------------------------------------------------------------------
# Setup
# -----------------------------------------------------------------------------
DATASET = os.path.splitext(os.path.basename(config["dataset"]))[0]
REPRESENTATIONS = config["representations"]
REPRESENTATIONS_NO_SELFIES = [r for r in REPRESENTATIONS if r!="SELFIES"]
SEEDS = config["seeds"]
FOLDS = config["folds"]
ENUM_FACTORS = config["enum_factors"]
METRICS = config["metrics"]
OUTPUT_DIR = config['output_dir']
MODEL_PARAMS = config['model_params']
ERR_PPM = config['err_ppm']

shell.executable("/bin/bash")

wildcard_constraints:
    dataset=DATASET,
    repr='|'.join(REPRESENTATIONS),
    fold='\d+',
    seed='\d+'

# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Rules
# -----------------------------------------------------------------------------
rule all:
    input:
        output_file=expand(f" f"{OUTPUT_DIR}/model_evaluation/{{dataset}}_calculate_outcomes.csv"", dataset=DATASET),

rule prep_outcome_freq:
    input:
        sample_file=f"{OUTPUT_DIR}/{{enum_factor}}/prior/samples/{{dataset}}_{{repr}}_{{fold}}_unique_masses.csv",
        max_molecules=50000
    output:
        f"{OUTPUT_DIR}/model_evaluation/{{dataset}}_{{repr}}_{{fold}}_unique_masses.csv"
    resources:
        mem_mb=12000,
        runtime=1000,
    shell:
        'clm inner_prep_outcomes_freq '
        '--sample_file {input.sample_file} '
        '--output_file {output} '
        '--max_molecules {input.max_molecules} '


rule calculate_outcomes:
    input:
        train_file=f"{OUTPUT_DIR}/{{enum_factor}}/prior/inputs/train_{{dataset}}_{{repr}}_{{fold}}.smi",
        sampled_file=f"{OUTPUT_DIR}/model_evaluation/{{dataset}}_{{repr}}_{{fold}}_unique_masses.csv",
        max_orig_mols=50000,
        seed=12
    output:
        f"{OUTPUT_DIR}/model_evaluation/{{dataset}}_calculate_outcomes.csv"
    resources:
        mem_mb=64000,
        runtime=1000,
    shell:
        'clm calculate_outcomes '
        '--train_file {input.train_file} '
        '--sampled_file {input.sampled_file} '
        '--max_orig_mols {input.max_orig_mols} '
        '--output_file {output} '


